#! /bin/sh

doo() { echo "$@" ; $@ ; }

echo 0 >list.exitstatus

<LIST.stu cat |
sed -e '/^[[:space:]]*$/d;/^[[:space:]]*#/d' |
while read -r line ; do

	echo "LINE: $line"

	{
		echo "# Autogenerated by $0 on $(date)"
		echo
		echo "$line"
	} >tmp.stu

	doo rm -f ? list.err

	echo ../../bin/stu.test -f tmp.stu
	../../bin/stu.test -f tmp.stu 2>list.err
	exitstatus=$?
	[ "$exitstatus" = 2 ] || {
		echo >&2 "*** error (a) Exit code should be 2 (logical error), but is not"
		echo >&2 "exitstatus=$exitstatus"
		echo 1 >list.exitstatus
		exit 1
	}

	grep -qF -e '-o' list.err || {
		echo >&2 "*** error (b) String \"-o\" not found in error output"
		echo >&2 "Content of error output:"
		echo >&2 ________
		cat  >&2 list.err
		echo >&2  ________
		echo 1 >list.exitstatus || exit 1
		exit 1
	}

done

rm -f tmp.stu || exit 2

exit $(cat list.exitstatus)
